# 🚨 안놀자 봇 (vcms-slack-anolja-bot)

야놀자 403 장애를 **자동 감지**하고, Slack 알림과 **원클릭 SMS 발송**으로 장애 대응을 자동화하는 봇입니다.

> 사람이 먼저 확인하는 게 아니라, 봇이 먼저 장애를 감지해서 알려줍니다.
> 문자 발송 문구는 PM이 직접 확인하고 컨펌한 뒤에만 발송됩니다.

---

## 핵심 컨셉

```
Retool 스케줄 쿼리 (주기적 403 체크)
        │
        │  에러 업장 ≥ 20개
        ▼
Slack 채널 알림 (장애 현황 + 📱 문자 발송 버튼)
        │
        │  PM 버튼 클릭
        ▼
Slack 모달 (기본 템플릿 문구 + 대상 번호 미리보기)
        │
        │  PM 문구 확인/수정 → 발송 컨펌
        ▼
Solapi SMS 발송 → 버튼 비활성화 → 결과 회신
        │
        │  에러 업장의 90% 정상 복구
        ▼
Slack 스레드 해제 알림 (📱 해제 문자 발송 버튼)
        │
        │  PM 버튼 클릭 → 모달 (해제 템플릿) → 컨펌
        ▼
해제 SMS 발송 → 버튼 비활성화
```

---

## 상태 머신

```
                    403 업장 ≥ 20개
 ┌──────┐  ─────────────────────────────▶  ┌───────────┐
 │      │                                   │           │
 │ 정상  │                                   │ 장애 발생  │
 │      │  ◀─────────────────────────────  │           │
 └──────┘   에러 업장 90% 정상 복구          └───────────┘
                + 쿨다운 경과                   │
                                               │ 장애 지속 중
                                               │ → 재감지되어도
                                               │   알림 안 감 (1회만)
                                               ▼
```

### 상태별 동작

| 상태 | 조건 | Slack 동작 | SMS |
|------|------|-----------|-----|
| **정상 → 장애** | 403 업장 ≥ 20개 | **채널**에 알림 + 발송 버튼 | PM 모달 컨펌 시 1회 |
| **장애 지속** | 임계치 이상 유지 | 추가 알림 없음 | 발송 불가 (버튼 비활성화) |
| **장애 → 해제** | 에러 업장 90% 복구 | 원래 알림의 **스레드**에 해제 알림 + 발송 버튼 | PM 모달 컨펌 시 1회 |

### 핵심 규칙

- **장애 발생 문자 1회 + 해제 문자 1회** — 하나의 장애 이벤트에서 최대 2회 발송
- **모든 문자 발송은 PM 컨펌 필수** — 버튼 클릭 → 모달 → 문구 확인/수정 → 발송
- **버튼 1회용** — 발송 컨펌 즉시 버튼 비활성화, 재발송 불가
- **해제 알림은 스레드** — 채널을 어지럽히지 않고, 원래 장애 알림에 이어서 표시
- **해제 문자는 선택적** — PM이 필요하다고 판단할 때만 발송

---

## 발송 플로우 상세

### 장애 발생 시

```
1. 봇이 채널에 알림 메시지 + [📱 문자 발송하기] 버튼
2. PM이 버튼 클릭
3. 모달 열림:
   ┌─────────────────────────────────────┐
   │  📱 야놀자 403 문자 발송             │
   │                                     │
   │  📋 발송 대상: 20건                  │
   │  010-1234-5678 (홍길동호텔)          │
   │  010-2345-6789 (제주리조트)          │
   │  ...                                │
   │                                     │
   │  📝 발송 문구:                       │
   │  ┌─────────────────────────────┐    │
   │  │ 야놀자 403 발생으로 인해     │    │
   │  │ 점검 중입니다.               │    │
   │  │ 잠시 후 다시 시도해주세요.    │    │
   │  └─────────────────────────────┘    │
   │  ↑ PM이 자유롭게 수정 가능           │
   │                                     │
   │         [ 발송 ]  [ 취소 ]           │
   └─────────────────────────────────────┘
4. PM이 문구 확인/수정 후 [발송] 클릭
5. Solapi SMS 발송 → 결과 회신
6. 원래 메시지의 버튼 비활성화
```

### 장애 해제 시

```
1. 봇이 원래 알림의 스레드에 해제 메시지 + [📱 해제 문자 발송] 버튼
2. PM이 버튼 클릭
3. 모달 열림:
   ┌─────────────────────────────────────┐
   │  📱 야놀자 403 해제 문자 발송        │
   │                                     │
   │  📋 발송 대상: 20건                  │
   │                                     │
   │  📝 발송 문구:                       │
   │  ┌─────────────────────────────┐    │
   │  │ 야놀자 403 장애가            │    │
   │  │ 해제되었습니다.              │    │
   │  │ 이용에 불편을 드려           │    │
   │  │ 죄송합니다.                  │    │
   │  └─────────────────────────────┘    │
   │  ↑ PM이 자유롭게 수정 가능           │
   │                                     │
   │         [ 발송 ]  [ 취소 ]           │
   └─────────────────────────────────────┘
4. PM이 문구 확인/수정 후 [발송] 클릭
5. Solapi SMS 발송 → 결과 회신
6. 원래 메시지의 버튼 비활성화
```

---

## 장애 감지 스펙

### 감지 조건
- **데이터 소스**: Retool Scheduled Query (기존 야놀자 403 조회 쿼리 활용)
- **체크 주기**: 1~15분 (부하에 따라 조절)
- **임계치**: 403 에러 업장 수 ≥ **20개**
- **알림 제한**: 동일 장애 이벤트 내 **1회만** 알림

### 해제 조건
- **대상**: 장애 발생 시점에 에러가 발생했던 업장들을 추적
- **기준**: 해당 업장 중 **90% 이상**이 동일 에러 미발생 시 해제
- **예시**: 23개 업장 403 발생 → 21개(91%) 정상 복구 → 해제

### 플래핑 방지
- 해제 후 일정 쿨다운 기간 동안 재알림 억제
- 쿨다운 중 다시 임계치 초과해도 즉시 알림하지 않음

### 문구 템플릿
- **장애 발생 기본 문구**: "야놀자 403 발생으로 인해 점검 중입니다. 잠시 후 다시 시도해주세요."
- **장애 해제 기본 문구**: "야놀자 403 장애가 해제되었습니다. 이용에 불편을 드려 죄송합니다."
- 모든 문구는 PM이 모달에서 **자유롭게 수정** 가능

---

## Slack 메시지 예시

### 1. 장애 감지 알림 (채널)

```
🚨 야놀자 403 장애 감지

감지 시간: 2026-02-16 09:30:00
에러 업장: 23개 (임계치: 20개)

📋 주요 업장:
  홍길동호텔, 제주리조트, 서울스테이 ...외 20건

[ 📱 문자 발송하기 ]  [ ❌ 무시 ]
```

### 2. 발송 완료 (컨펌 후 메시지 업데이트)

```
✅ 문자 발송 완료!
성공: 20건 / 실패: 0건
발송 시간: 2026-02-16 09:33:21
발송자: @PM이름

(📱 문자 발송하기 — 발송 완료됨)
```

### 3. 장애 해제 알림 (스레드)

```
✅ 야놀자 403 장애 해제

해제 시간: 2026-02-16 11:45:00
복구 업장: 21/23개 (91%)
장애 지속 시간: 2시간 15분

[ 📱 해제 문자 발송 ]  [ ❌ 발송 안함 ]
```

---

## 아키텍처

```
┌──────────────────┐
│  Retool          │  스케줄 쿼리 (1~15분 주기)
│  Scheduled Query │  야놀자 403 에러 조회
└────────┬─────────┘
         │  에러 업장 ≥ 20개
         ▼
┌──────────────────┐
│  Slack 채널 알림  │  장애 현황 + 발송 버튼
└────────┬─────────┘
         │  PM 버튼 클릭
         ▼
┌──────────────────┐
│  Slack 모달      │  기본 템플릿 + PM 수정/컨펌
└────────┬─────────┘
         │  발송 컨펌
         ▼
┌──────────────────┐
│  Retool Workflow │  대상 추출 + 중복 제거 + 번호 정제
└────────┬─────────┘
         ▼
┌──────────────────┐
│  Solapi API      │  SMS 일괄 발송
└────────┬─────────┘
         ▼
┌──────────────────┐
│  Slack 결과 회신  │  발송 결과 + 버튼 비활성화
└──────────────────┘

         ... 에러 업장 90% 복구 ...

┌──────────────────┐
│  Slack 스레드    │  해제 알림 + 해제 문자 버튼
│  → 모달 → 컨펌   │  → SMS 발송 → 버튼 비활성화
└──────────────────┘
```

---

## 기술 스택

| 구분 | 기술 | 역할 |
|------|------|------|
| 장애 감지 | **Retool Scheduled Query** | 주기적 403 조회, 임계치 판단, 업장 추적 |
| 봇 프레임워크 | **Slack Bolt (Node.js)** | Interactive Message, 모달, 버튼 콜백 |
| 대상 추출 | **Retool Workflow** | DB 쿼리, 중복 제거, 번호 정규식 정제 |
| 문자 발송 | **Solapi** (`solapi-node`) | SMS 일괄 발송 API |
| 메시지 UI | **Slack Block Kit + Modal** | 알림, 버튼, 문구 입력 모달, 결과 리포트 |

---

## 프로젝트 구조

```
vcms-slack-anolja-bot/
├── src/
│   ├── app.js                  # Slack Bolt 앱 엔트리포인트
│   ├── monitor/
│   │   ├── alertState.js       # 장애 상태 관리 (감지/해제/쿨다운)
│   │   └── shopTracker.js      # 에러 업장 추적 (해제 판단용)
│   ├── actions/
│   │   ├── openSmsModal.js     # [문자 발송하기] → 모달 열기
│   │   ├── openRecoveryModal.js # [해제 문자 발송] → 모달 열기
│   │   ├── dismiss.js          # [무시] 버튼 핸들러
│   │   └── skipRecovery.js     # [발송 안함] 버튼 핸들러
│   ├── views/
│   │   └── smsModal.js         # 문자 발송 모달 (문구 입력/수정 + 대상 미리보기)
│   ├── submissions/
│   │   └── handleSmsSend.js    # 모달 제출 → SMS 발송 + 버튼 비활성화
│   ├── services/
│   │   ├── retool.js           # Retool Workflow API 호출
│   │   ├── solapi.js           # Solapi SMS 발송
│   │   └── phoneParser.js      # 번호 정규식 정제 유틸
│   └── blocks/
│       ├── alertMessage.js     # 장애 감지 알림 Block Kit
│       ├── recoveryMessage.js  # 장애 해제 알림 Block Kit (스레드)
│       └── resultMessage.js    # 발송 결과 Block Kit
├── templates/
│   ├── alert.txt               # 장애 발생 기본 문구 템플릿
│   └── recovery.txt            # 장애 해제 기본 문구 템플릿
├── .env.example
├── package.json
├── README.md
└── Dockerfile
```

---

## 환경 변수

```env
# Slack
SLACK_BOT_TOKEN=xoxb-xxxx
SLACK_SIGNING_SECRET=xxxx
SLACK_APP_TOKEN=xapp-xxxx              # Socket Mode 사용 시
SLACK_ALERT_CHANNEL=C0XXXXXXX          # 장애 알림 채널 ID

# Retool
RETOOL_WORKFLOW_URL=https://api.retool.com/v1/workflows/xxx/startTrigger
RETOOL_API_KEY=xxxx

# Solapi
SOLAPI_API_KEY=xxxx
SOLAPI_API_SECRET=xxxx
SOLAPI_SENDER=02-xxxx-xxxx             # 발신번호 (사전 등록 필수)

# 모니터링 설정
ALERT_THRESHOLD=20                     # 장애 감지 임계치 (에러 업장 수)
RECOVERY_RATE=90                       # 해제 기준 (에러 업장 복구 비율 %)
CHECK_INTERVAL_MIN=5                   # 체크 주기 (분)
COOLDOWN_MIN=30                        # 해제 후 쿨다운 (분)
```

---

## 빠른 시작

```bash
git clone https://github.com/yujy118/vcms-slack-anolja-bot.git
cd vcms-slack-anolja-bot
npm install
cp .env.example .env   # 토큰/키 입력
npm start
```

---

## 설정 가이드

### 1. Slack App (안놀자 봇)

1. [api.slack.com/apps](https://api.slack.com/apps) → 안놀자 봇 선택
2. **Interactivity & Shortcuts** → ON → Request URL 세팅
3. **OAuth & Permissions** → Bot Token Scopes:
   - `chat:write`, `chat:write.public`
4. **Install to Workspace**

### 2. Retool

**Scheduled Query (장애 감지)**
- 기존 야놀자 403 조회 쿼리를 스케줄로 전환
- 에러 업장 ≥ 20개 → Slack Webhook 호출
- 해제 판단: 에러 업장의 90% 정상 복구 추적

**Workflow (대상 추출)**
- Webhook Trigger → 대상 추출 + 중복 제거 + 번호 정제
- Response: `{ phones: [{ number, name }], total, duplicateRemoved }`

### 3. Solapi

1. [solapi.com](https://solapi.com) → 가입, 발신번호 등록
2. API Key/Secret 발급 → `.env`에 세팅
3. SDK: `npm install solapi`
4. 문서: [developers.solapi.dev](https://developers.solapi.dev/intro)

---

## 진행 상황

- [x] 컨셉 확정
- [x] GitHub 레포 생성
- [x] README 작성
- [ ] Slack App 설정 (안놀자 봇)
- [ ] Retool Scheduled Query (403 감지 + 해제 판단)
- [ ] Retool Workflow (대상 추출 API)
- [ ] Slack Bolt 앱 세팅 (Node.js)
- [ ] 장애 상태 관리 (감지/해제/쿨다운)
- [ ] 에러 업장 추적 (해제 90% 복구 판단)
- [ ] Slack 모달 (문구 입력/수정 + 대상 미리보기)
- [ ] Solapi SMS 연동
- [ ] 버튼 비활성화 처리
- [ ] 해제 알림 스레드 + 해제 모달
- [ ] 에러 핸들링
- [ ] 배포

---

## 라이선스

VENDIT 내부 프로젝트
