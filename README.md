# 🚨 안놀자 봇 (vcms-slack-anolja-bot)

야놀자 403 장애를 **자동 감지**하고, Slack 알림과 **원클릭 SMS 발송**으로 장애 대응을 자동화하는 봇입니다.

> 사람이 먼저 확인하는 게 아니라, 봇이 먼저 장애를 감지해서 알려줍니다.
> 문자 발송 문구는 PM이 직접 확인하고 컨펌한 뒤에만 발송됩니다.

---

## 핵심 컨셉

```
Retool 스케줄 쿼리 (주기적 403 체크)
        │
        │  에러 업장 ≥ 20개
        ▼
Slack 채널 알림 (장애 현황 + 📱 문자 발송 버튼)
        │
        │  PM 버튼 클릭
        ▼
Slack 모달 (템플릿 선택 + 문구 수정 + 대상 미리보기 + 책임 확인 체크)
        │
        │  PM 컨펌 (레이스 컨디션 체크 → 1인만 통과)
        ▼
Solapi SMS 발송 → 버튼 비활성화 → 결과 회신 (실패 시 스레드 상세)
        │
        │  장애 시점 업장의 90% 정상 복구
        ▼
Slack 스레드 해제 알림 → 모달 → 해제 SMS → 버튼 비활성화
```

---

## 상태 머신

```
                    403 업장 ≥ 20개
 ┌──────┐  ─────────────────────────────▶  ┌───────────┐
 │      │                                   │           │
 │ 정상  │                                   │ 장애 발생  │
 │      │  ◀─────────────────────────────  │           │
 └──────┘   장애 시점 업장 90% 복구          └───────────┘
                + 쿨다운 경과                   │
                                               │ 장애 지속 중
                                               │ → 재감지되어도
                                               │   알림 안 감 (1회만)
                                               ▼
```

### 상태별 동작

| 상태 | 조건 | Slack 동작 | SMS |
|------|------|-----------|-----|
| **정상 → 장애** | 403 업장 ≥ 20개 | **채널**에 알림 + 발송 버튼 | PM 모달 컨펌 시 1회 |
| **장애 지속** | 임계치 이상 유지 | 추가 알림 없음 | 발송 불가 (버튼 비활성화) |
| **장애 → 해제** | 장애 시점 업장 90% 복구 | 원래 알림의 **스레드**에 해제 알림 + 발송 버튼 | PM 모달 컨펌 시 1회 |

### 핵심 규칙

- **장애 발생 문자 1회 + 해제 문자 1회** — 하나의 장애 이벤트에서 최대 2회 발송
- **모든 문자 발송은 PM 컨펌 필수** — 모달에서 문구 확인 + 책임 체크박스
- **중복 발송 원천 차단** — 동시에 여러 명이 모달을 열어도 1인만 발송 통과
- **발송자 자동 기록** — 누가 발송을 승인했는지 결과 메시지에 명시
- **버튼 1회용** — 발송 컨펌 즉시 버튼 비활성화, 재발송 불가
- **무시 버튼도 로그** — 무시 클릭 시 누가 언제 무시했는지 채널에 박제
- **해제 알림은 스레드** — 채널을 어지럽히지 않고, 원래 장애 알림에 이어서 표시
- **해제 문자는 선택적** — PM이 필요하다고 판단할 때만 발송
- **실패 건 상세 리포트** — 발송 실패 시 스레드로 상세 내역 제공

---

## 발송 플로우 상세

### 장애 발생 시

```
1. 봇이 채널에 알림 메시지 + [📱 문자 발송하기] 버튼
2. PM이 버튼 클릭
3. 모달 열림:
   ┌─────────────────────────────────────────┐
   │  📱 야놀자 403 문자 발송                  │
   │                                          │
   │  📋 발송 대상: 20건                       │
   │  010-1234-5678 (홍길동호텔)               │
   │  010-2345-6789 (제주리조트)               │
   │  ...                                     │
   │                                          │
   │  📝 템플릿 선택: [드롭다운 ▼]              │
   │  ┌────────────────────────────────┐      │
   │  │ [긴급] 장애 안내               │      │
   │  │ [지연] 복구 지연               │      │
   │  │ [완료] 정상 복구               │      │
   │  │ 직접 입력                      │      │
   │  └────────────────────────────────┘      │
   │                                          │
   │  📝 발송 문구:                            │
   │  ┌────────────────────────────────┐      │
   │  │ 현재 야놀자 403 장애로 점검     │      │
   │  │ 중입니다. 잠시 후 다시          │      │
   │  │ 시도해주세요.                   │      │
   │  └────────────────────────────────┘      │
   │  ↑ 템플릿 선택 시 자동 채워짐,            │
   │    PM이 자유롭게 수정 가능                 │
   │                                          │
   │  ☑ 본인은 해당 문구 발송에 따른            │
   │    책임을 확인했습니다. (필수)              │
   │                                          │
   │           [ 발송 ]  [ 취소 ]              │
   └─────────────────────────────────────────┘
4. PM이 문구 확인/수정 + 책임 체크 후 [발송] 클릭
5. 레이스 컨디션 체크 → 이미 발송 완료된 건이면 에러 메시지
6. Solapi SMS 발송
7. 결과 회신 + 버튼 비활성화
8. 실패 건이 있으면 스레드로 상세 내역 전송
```

### 장애 해제 시

```
1. 봇이 원래 알림의 스레드에 해제 메시지 + [📱 해제 문자 발송] 버튼
2. PM이 버튼 클릭
3. 동일한 모달 (해제 템플릿 기본 선택)
4. PM 컨펌 → 레이스 컨디션 체크 → 발송 → 버튼 비활성화
```

### 무시 시

```
1. PM이 [❌ 무시] 버튼 클릭
2. 메시지가 삭제되지 않고, 내용이 업데이트됨:

   ❌ 야놀자 403 장애 알림 무시됨
   처리자: @김철수PM
   처리 시간: 2026-02-16 09:35:00

3. 장애 상태는 유지 (재알림은 안 감)
```

---

## 문구 템플릿

모달 상단에 드롭다운으로 빠른 선택 제공. 선택 시 텍스트 박스에 자동 채워지고, PM이 자유롭게 수정 가능.

| 템플릿 | 기본 문구 |
|--------|----------|
| **[긴급] 장애 안내** | "현재 야놀자 403 장애로 점검 중입니다. 잠시 후 다시 시도해주세요." |
| **[지연] 복구 지연** | "복구 작업이 길어지고 있습니다. 잠시만 더 기다려주세요." |
| **[완료] 정상 복구** | "장애가 해결되었습니다. 정상 이용이 가능합니다." |
| **직접 입력** | (텍스트 박스 비움, PM이 직접 작성) |

---

## 발송 결과 리포트

### 성공 시 (채널 메시지 업데이트)

```
✅ SMS 발송 완료 (총 23건)

성공: 20건
실패: 3건 (상세 내역은 아래 스레드 확인)

발송 승인자: @김철수PM
선택 템플릿: [긴급] 장애 안내
발송 시간: 2026-02-16 09:33:21

(📱 문자 발송하기 — 발송 완료됨)
```

### 실패 상세 (스레드)

```
❌ 발송 실패 상세: 3건

  홍길동호텔 (010-1234-5xx): 결번 혹은 수신 거부
  제주리조트 (010-2345-6xx): Solapi 잔액 부족
  서울스테이 (010-3456-7xx): 수신 거부

💡 잔액 부족인 경우 solapi.com에서 충전 후 재시도가 필요합니다.
```

---

## 🛡️ 운영 안정성 및 책임 추적

### 중복 발송 방지 (Race Condition)

PM 두 명이 동시에 모달을 열 수는 있지만, [발송] 버튼을 누르는 마지막 순간에는 **1인만 통과**.

- 모달 생성 시 `private_metadata`에 `incident_id` (장애 고유 ID)를 심어서 전달
- `view_submission` 핸들러에서 해당 ID의 상태를 원자적으로 체크
- 상태가 이미 `COMPLETED`면 → 모달에 에러 메시지 표시 ("이미 다른 PM님이 발송을 완료했습니다")
- 통과 시 → 상태를 즉시 `COMPLETED`로 변경 후 SMS 발송 진행

```javascript
// src/submissions/handleSmsSend.js 핵심 로직
app.view('sms_modal_submit', async ({ ack, body, view, client }) => {
  const incidentId = view.private_metadata;
  const userId = body.user.id;

  // 1. 상태 체크 (Atomic)
  const currentState = await alertState.getState(incidentId);

  if (currentState === 'COMPLETED') {
    // 이미 발송됨 → 에러 표시
    return ack({
      response_action: 'errors',
      errors: {
        sms_text_input: '이미 다른 PM님이 발송을 완료했습니다. (확인 필요)'
      }
    });
  }

  // 2. 즉시 상태 변경 (중복 진입 방지)
  await alertState.setState(incidentId, 'COMPLETED');
  await ack();

  // 3. SMS 발송 실행...
});
```

### 무시 버튼 로그화

[❌ 무시] 클릭 시 메시지를 **삭제하지 않고**, 누가 언제 무시했는지 채널에 **박제**.
"알림을 못 봤다"가 아니라 **"누가 확인하고 무시했다"**를 명확히 기록.

```javascript
// src/actions/dismiss.js 핵심 로직
app.action('dismiss_alert', async ({ ack, body, client }) => {
  await ack();

  const userId = body.user.id;
  const channelId = body.channel.id;
  const messageTs = body.message.ts;

  // 메시지 삭제 대신 업데이트로 로그 남김
  await client.chat.update({
    channel: channelId,
    ts: messageTs,
    blocks: [
      {
        type: 'section',
        text: {
          type: 'mrkdwn',
          text: `❌ *야놀자 403 장애 알림 무시됨*\n처리자: <@${userId}>\n처리 시간: ${new Date().toLocaleString()}`
        }
      }
    ]
  });
});
```

### 발송 책임 확인

- 모달 하단에 **필수 체크박스**: `☑ 본인은 해당 문구 발송에 따른 책임을 확인했습니다.`
- 체크하지 않으면 발송 불가
- Slack 인터랙션 페이로드에서 `user_id` 추출 → 결과 메시지에 **"@이름 님이 발송을 승인함"** 명시
- 심리적 장벽 + 감사 로그 역할 → 실수 발송 방지

### 모든 행동은 추적됨

| 행동 | 기록 내용 |
|------|----------|
| 문자 발송 | 승인자, 선택 템플릿, 발송 시간, 성공/실패 건수 |
| 해제 문자 발송 | 승인자, 선택 템플릿, 발송 시간 |
| 알림 무시 | 처리자, 처리 시간 |
| 해제 문자 발송 안함 | 처리자, 처리 시간 |

---

## 장애 감지 스펙

### 감지 조건
- **데이터 소스**: Retool Scheduled Query (기존 야놀자 403 조회 쿼리 활용)
- **체크 주기**: 1~15분 (부하에 따라 조절)
- **임계치**: 403 에러 업장 수 ≥ **20개**
- **알림 제한**: 동일 장애 이벤트 내 **1회만** 알림

### 해제 조건 (업장 고정 추적)
- **추적 대상 고정**: 장애 발생 시점에 에러가 발생한 업장 리스트를 스냅샷으로 저장
- **기준**: 해당 스냅샷 업장 중 **90% 이상**이 동일 에러 미발생 시 해제
- **예시**: A, B, C ... 23개 업장 403 발생 → 그 23개 중 21개(91%) 정상 복구 → 해제
- ⚠️ **주의**: "현재 전체 에러 수"로 판단하면 새로운 에러가 섞여 판단이 꼬임. 반드시 장애 시점 업장을 고정 추적.

### 플래핑 방지
- 해제 후 일정 쿨다운 기간 동안 재알림 억제
- 쿨다운 중 다시 임계치 초과해도 즉시 알림하지 않음

---

## Slack 메시지 예시

### 1. 장애 감지 알림 (채널)

```
🚨 야놀자 403 장애 감지

감지 시간: 2026-02-16 09:30:00
에러 업장: 23개 (임계치: 20개)

📋 주요 업장:
  홍길동호텔, 제주리조트, 서울스테이 ...외 20건

[ 📱 문자 발송하기 ]  [ ❌ 무시 ]
```

### 2. 발송 완료 (메시지 업데이트)

```
✅ SMS 발송 완료 (총 23건)

성공: 20건
실패: 3건 (상세 내역은 아래 스레드 확인)

발송 승인자: @김철수PM
선택 템플릿: [긴급] 장애 안내
발송 시간: 2026-02-16 09:33:21

(📱 문자 발송하기 — 발송 완료됨)
```

### 3. 실패 상세 (스레드)

```
❌ 발송 실패 상세: 3건

  홍길동호텔 (010-1234-5xx): 결번 혹은 수신 거부
  제주리조트 (010-2345-6xx): Solapi 잔액 부족
  서울스테이 (010-3456-7xx): 수신 거부
```

### 4. 알림 무시됨 (메시지 업데이트)

```
❌ 야놀자 403 장애 알림 무시됨
처리자: @김철수PM
처리 시간: 2026-02-16 09:35:00
```

### 5. 장애 해제 알림 (스레드)

```
✅ 야놀자 403 장애 해제

해제 시간: 2026-02-16 11:45:00
복구 업장: 21/23개 (91%)
장애 지속 시간: 2시간 15분

[ 📱 해제 문자 발송 ]  [ ❌ 발송 안함 ]
```

---

## 아키텍처

```
┌──────────────────┐
│  Retool          │  스케줄 쿼리 (1~15분 주기)
│  Scheduled Query │  야놀자 403 에러 조회
└────────┬─────────┘
         │  에러 업장 ≥ 20개
         ▼
┌──────────────────┐
│  Slack 채널 알림  │  장애 현황 + 발송 버튼
└────────┬─────────┘
         │  PM 버튼 클릭
         ▼
┌──────────────────┐
│  Slack 모달      │  템플릿 드롭다운 + 문구 수정
│                  │  대상 미리보기 + 책임 체크박스
└────────┬─────────┘
         │  컨펌 (레이스 컨디션 체크 + 체크박스 필수)
         ▼
┌──────────────────┐
│  Retool Workflow │  대상 추출 + 중복 제거 + 번호 정제
└────────┬─────────┘
         ▼
┌──────────────────┐
│  Solapi API      │  SMS 일괄 발송
└────────┬─────────┘
         ▼
┌──────────────────┐
│  Slack 결과 회신  │  발송 결과 + 승인자 명시
│  + 버튼 비활성화  │  + 실패 시 스레드 상세
└──────────────────┘

         ... 장애 시점 업장 90% 복구 ...

┌──────────────────┐
│  Slack 스레드    │  해제 알림 + 해제 문자 버튼
│  → 모달 → 컨펌   │  → SMS 발송 → 버튼 비활성화
└──────────────────┘
```

---

## 기술 스택

| 구분 | 기술 | 역할 |
|------|------|------|
| 장애 감지 | **Retool Scheduled Query** | 주기적 403 조회, 임계치 판단, 업장 스냅샷 |
| 봇 프레임워크 | **Slack Bolt (Node.js)** | Interactive Message, 모달, 버튼 콜백 |
| 대상 추출 | **Retool Workflow** | DB 쿼리, 중복 제거, 번호 정규식 정제 |
| 문자 발송 | **Solapi** (`solapi-node`) | SMS 일괄 발송 API |
| 상태 관리 | **In-memory / Redis** | 장애 상태, 레이스 컨디션 방지, 쿨다운 |
| 메시지 UI | **Slack Block Kit + Modal** | 알림, 템플릿 드롭다운, 체크박스, 결과 리포트 |

---

## 프로젝트 구조

```
vcms-slack-anolja-bot/
├── src/
│   ├── app.js                  # Slack Bolt 앱 엔트리포인트
│   ├── monitor/
│   │   ├── alertState.js       # 장애 상태 관리 (감지/해제/쿨다운/레이스 컨디션)
│   │   └── shopTracker.js      # 에러 업장 스냅샷 + 복구 추적
│   ├── actions/
│   │   ├── openSmsModal.js     # [문자 발송하기] → 모달 열기
│   │   ├── openRecoveryModal.js # [해제 문자 발송] → 모달 열기
│   │   ├── dismiss.js          # [무시] → 메시지 업데이트 (처리자 박제)
│   │   └── skipRecovery.js     # [발송 안함] → 메시지 업데이트 (처리자 박제)
│   ├── views/
│   │   └── smsModal.js         # 모달 (템플릿 드롭다운 + 문구 + 체크박스)
│   ├── submissions/
│   │   └── handleSmsSend.js    # 모달 제출 → 레이스 컨디션 체크 → SMS 발송
│   ├── services/
│   │   ├── retool.js           # Retool Workflow API 호출
│   │   ├── solapi.js           # Solapi SMS 발송 + 실패 상세 파싱
│   │   └── phoneParser.js      # 번호 정규식 정제 유틸
│   └── blocks/
│       ├── alertMessage.js     # 장애 감지 알림 Block Kit
│       ├── recoveryMessage.js  # 장애 해제 알림 Block Kit (스레드)
│       ├── resultMessage.js    # 발송 결과 Block Kit (승인자 포함)
│       ├── failureDetail.js    # 발송 실패 상세 Block Kit (스레드)
│       └── dismissedMessage.js # 알림 무시됨 Block Kit (처리자 박제)
├── templates/
│   ├── urgent.txt              # [긴급] 장애 안내
│   ├── delayed.txt             # [지연] 복구 지연
│   └── resolved.txt            # [완료] 정상 복구
├── .env.example
├── package.json
├── README.md
└── Dockerfile
```

---

## 환경 변수

```env
# Slack
SLACK_BOT_TOKEN=xoxb-xxxx
SLACK_SIGNING_SECRET=xxxx
SLACK_APP_TOKEN=xapp-xxxx              # Socket Mode 사용 시
SLACK_ALERT_CHANNEL=C0XXXXXXX          # 장애 알림 채널 ID

# Retool
RETOOL_WORKFLOW_URL=https://api.retool.com/v1/workflows/xxx/startTrigger
RETOOL_API_KEY=xxxx

# Solapi
SOLAPI_API_KEY=xxxx
SOLAPI_API_SECRET=xxxx
SOLAPI_SENDER=02-xxxx-xxxx             # 발신번호 (사전 등록 필수)

# 모니터링 설정
ALERT_THRESHOLD=20                     # 장애 감지 임계치 (에러 업장 수)
RECOVERY_RATE=90                       # 해제 기준 (장애 시점 업장 복구 비율 %)
CHECK_INTERVAL_MIN=5                   # 체크 주기 (분)
COOLDOWN_MIN=30                        # 해제 후 쿨다운 (분)
```

---

## 빠른 시작

```bash
git clone https://github.com/yujy118/vcms-slack-anolja-bot.git
cd vcms-slack-anolja-bot
npm install
cp .env.example .env   # 토큰/키 입력
npm start
```

---

## 설정 가이드

### 1. Slack App (안놀자 봇)

1. [api.slack.com/apps](https://api.slack.com/apps) → 안놀자 봇 선택
2. **Interactivity & Shortcuts** → ON → Request URL 세팅
3. **OAuth & Permissions** → Bot Token Scopes:
   - `chat:write`, `chat:write.public`
4. **Install to Workspace**

### 2. Retool

**Scheduled Query (장애 감지)**
- 기존 야놀자 403 조회 쿼리를 스케줄로 전환
- 에러 업장 ≥ 20개 → Slack Webhook 호출
- 장애 시점 업장 리스트 스냅샷 저장
- 해제 판단: 스냅샷 업장의 90% 정상 복구 추적

**Workflow (대상 추출)**
- Webhook Trigger → 대상 추출 + 중복 제거 + 번호 정제
- Response: `{ phones: [{ number, name }], total, duplicateRemoved }`

### 3. Solapi

1. [solapi.com](https://solapi.com) → 가입, 발신번호 등록
2. API Key/Secret 발급 → `.env`에 세팅
3. SDK: `npm install solapi`
4. 문서: [developers.solapi.dev](https://developers.solapi.dev/intro)

---

## 진행 상황

- [x] 컨셉 확정
- [x] GitHub 레포 생성
- [x] README 작성
- [ ] Slack App 설정 (안놀자 봇)
- [ ] Retool Scheduled Query (403 감지 + 업장 스냅샷 + 해제 판단)
- [ ] Retool Workflow (대상 추출 API)
- [ ] Slack Bolt 앱 세팅 (Node.js)
- [ ] 장애 상태 관리 (감지/해제/쿨다운)
- [ ] 레이스 컨디션 방지 (incident_id 기반 중복 발송 차단)
- [ ] 업장 스냅샷 기반 복구 추적
- [ ] Slack 모달 (템플릿 드롭다운 + 문구 수정 + 책임 체크박스)
- [ ] Solapi SMS 연동
- [ ] 발송 결과 리포트 (승인자 명시 + 실패 상세 스레드)
- [ ] 무시 버튼 로그화 (처리자 박제)
- [ ] 버튼 비활성화 처리
- [ ] 해제 알림 스레드 + 해제 모달
- [ ] 에러 핸들링
- [ ] 배포

---

## 라이선스

VENDIT 내부 프로젝트
